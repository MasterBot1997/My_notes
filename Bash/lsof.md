
## Опции lsof

  
Ветеран SRE, который занимался этим делом за десятилетия до того, как появился термин «SRE», однажды сказал мне: «Я перестал изучать опции lsof как только узнал все те, которые мне нужны. Изучи самое важное, и это будет всем, что тебе когда-либо понадобится».  
  
Утилита `lsof` имеет обширный набор опций.  
  

```
NAME
lsof - list open files
SYNOPSIS
lsof  [  -?abChKlnNOPRtUvVX  ]  [ -A A ] [ -c c ] [ +c c ] [ +|-d d ] [+|-D D ] [ +|-e s ] [ +|-f [cfgGn] ] [ -F [f] ] [ -g [s] ] [ -i [i] ] [-k  k  ]  [  +|-L  [l] ] [ +|-m m ] [ +|-M ] [ -o [o] ] [ -p s ] [ +|-r[t[m<fmt>]] ] [ -s [p:s] ] [ -S [t] ] [ -T [t] ] [ -u s ] [ +|-w ] [ -x[fl] ] [ -z [z] ] [ -Z [Z] ] [ -- ] [names]
```

  
Если вы хотите изучит их все — [man](https://linux.die.net/man/8/lsof) вам в помощь. Здесь же мне хотелось бы рассказать о тех, которыми обычно пользуюсь я.  
  

### ▍Опция -u

  
Опция `-u` выводит список файлов, открытых конкретным пользователем. Следующий пример показывает, как можно узнать, сколько файлов держит открытыми пользователь `cindy`.  
  

```
cindy@ubuntu:~$ lsof -u cindy | wc -l
248
```

  
Обычно, если перед параметром некоей опции ставят знак «^» (крышка), который означает отрицание, это приводит к исключению файлов, соответствующих данному параметру, из вывода программы. Вот, например, как можно узнать количество файлов на компьютере, которые открыты всеми пользователями за исключением `cindy`.  
  

```
cindy@ubuntu:~$ lsof -u^cindy | wc -l
38193
```

  

### ▍Опция -U

  
Опция `-U` позволяет вывести все файлы сокетов домена Unix.  
  

```
cindy@ubuntu:~$ lsof -U | head -5
COMMAND     PID       USER   FD   TYPE             DEVICE SIZE/OFF    NODE NAME
init          1       root    7u  unix 0xffff88086a171f80      0t0   24598 @/com/ubuntu/upstart
init          1       root    9u  unix 0xffff88046a22b480      0t0   22701 socket
init          1       root   10u  unix 0xffff88086a351180      0t0   39003 @/com/ubuntu/upstart
init          1       root   11u  unix 0xffff880469006580      0t0   16510 @/com/ubuntu/upstart
```

  

### ▍Опция -c

  
Опция `-c` позволяет вывести сведения о файлах, которые держат открытыми процессы, выполняющие команды, имена которых начинаются с заданных символов. Например, вот какая команда позволит увидеть первые 15 файлов, открытых всеми процессами Python, выполняющимися на компьютере.  
  

```
cindy@ubuntu:~$ lsof -cpython | head -15
COMMAND     PID USER   FD   TYPE             DEVICE SIZE/OFF       NODE NAME
python2.7 16905 root  cwd    DIR                9,1     4096  271589387 /home/cindy/sourcebox
python2.7 16905 root  rtd    DIR                9,1     4096       2048 /
python2.7 16905 root  txt    REG                9,1  3345416  268757001 /usr/bin/python2.7
python2.7 16905 root  mem    REG                9,1    11152 1610852447 /usr/lib/python2.7/lib-dynload/resource.x86_64-linux-gnu.so
python2.7 16905 root  mem    REG                9,1   101240 1610899495 /lib/x86_64-linux-gnu/libresolv-2.19.so
python2.7 16905 root  mem    REG                9,1    22952 1610899509 /lib/x86_64-linux-gnu/libnss_dns-2.19.so
python2.7 16905 root  mem    REG                9,1    47712 1610899515 /lib/x86_64-linux-gnu/libnss_files-2.19.so
python2.7 16905 root  mem    REG                9,1    33448 1610852462 /usr/lib/python2.7/lib-dynload/_multiprocessing.x86_64-linux-gnu.so
python2.7 16905 root  mem    REG                9,1    54064 1610852477 /usr/lib/python2.7/lib-dynload/_json.x86_64-linux-gnu.so
python2.7 16905 root  mem    REG                9,1    18936 1610619044 /lib/x86_64-linux-gnu/libuuid.so.1.3.0
python2.7 16905 root  mem    REG                9,1    30944 1207967802 /usr/lib/x86_64-linux-gnu/libffi.so.6.0.1
python2.7 16905 root  mem    REG                9,1   136232 1610852472 /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so
python2.7 16905 root  mem    REG                9,1    77752 1610852454 /usr/lib/python2.7/lib-dynload/parser.x86_64-linux-gnu.so
python2.7 16905 root  mem    REG                9,1   387256 1610620979 /lib/x86_64-linux-gnu/libssl.so.1.0.0
```

  
Вот ещё интересный пример. Например, имеется некоторое количество процессов Python 2.7 и Python 3.6, при этом надо выяснить, какие файлы открыты процессами, которые не являются процессами Python 2.7. Сделать это можно так:  
  

```
cindy@ubuntu:~$ lsof -cpython -c^python2.7 | head -10
COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF       NODE NAME
python  20017 root  cwd    DIR    9,1     4096       2048 /
python  20017 root  rtd    DIR    9,1     4096       2048 /
python  20017 root  txt    REG    9,1  3345416  268757001 /usr/bin/python2.7
python  20017 root  mem    REG    9,1    11152 1610852447 /usr/lib/python2.7/lib-dynload/resource.x86_64-linux-gnu.so
python  20017 root  mem    REG    9,1     6256  805552236 /usr/lib/python2.7/dist-packages/_psutil_posix.x86_64-linux-gnu.so
python  20017 root  mem    REG    9,1    14768  805552237 /usr/lib/python2.7/dist-packages/_psutil_linux.x86_64-linux-gnu.so
python  20017 root  mem    REG    9,1    10592  805451779 /usr/lib/python2.7/dist-packages/Crypto/Util/strxor.x86_64-linux-gnu.so
python  20017 root  mem    REG    9,1    11176 1744859170 /usr/lib/python2.7/dist-packages/Crypto/Cipher/_ARC4.x86_64-linux-gnu.so
python  20017 root  mem    REG    9,1    23560 1744859162 /usr/lib/python2.7/dist-packages/Crypto/Cipher/_Blowfish.x86_64-linux-gnu.so
```

  

### ▍Опция +d

  
Опция `+d` позволяет выяснить, какие папки и файлы открыты в некоей директории (но не в её поддиректориях).  
  

```
cindy@ubuntu:~$ lsof +d /usr/bin | head -4
COMMAND     PID     USER  FD   TYPE DEVICE SIZE/OFF   NODE NAME
circusd    1351     root txt    REG    9,1  3345416 268757001 /usr/bin/python2.7
docker     1363     root txt    REG    9,1 19605520 270753792 /usr/bin/docker
runsvdir   1597     root txt    REG    9,1    17144 272310314 /usr/bin/runsvdir
```

  

### ▍Опция -d

  
Пожалуй, опция `-d` — это одна из тех, которыми я пользуюсь чаще всего. Уступает она только опции `-p`. Эта опция позволяет задать список дескрипторов файлов, разделённых запятой, которые надо включить в вывод или исключить из него. Вот что говорит об этом документация:  
  
`Список исключается из вывода, если все записи в наборе начинаются со знака «^». Список будет включён в вывод, если ни одна запись не начинается с «^». Смешивание записей разных видов не разрешается.      В списке может присутствовать диапазон номеров дескрипторов файлов при условии, что ни один из его членов не пуст, оба члена являются числами, и завершающий член больше начального - то есть: «0-7» или «3-10».      Диапазоны могут быть использованы для исключения записей из вывода, если перед ними стоит префикс «^», то есть - «^0-7» исключает все дескрипторы с 0 по 7.      Вывод по нескольким номерам дескрипторов файлов объединяется в соответствии с правилами логического ИЛИ, в один набор, прежде чем к ним будет применена операция логического И.      Когда в наборе встречаются и включаемые и исключаемые члены, lsof сообщает об ошибке и завершает работу с ненулевым кодом возврата.`  
  

### ▍Опция -p

  
Не могу вспомнить, когда я не пользовался бы опцией `-p`, работая с `lsof`. Она позволяет вывести все файлы, открытые процессом с указанным при вызове команды PID.  
  
Например, вот как в Ubuntu выглядит вывод информации обо всех файлах, открытых процессом, скажем, с PID 1.  
  
![](https://habrastorage.org/r/w1560/getpro/habr/post_images/e98/575/166/e98575166593363948969af414854944.png)  
_Вывод команды lsof, вызванной с опцией -p в Ubuntu_  
  
Вот что выводится на моём MacBook Air.  
  
![](https://habrastorage.org/r/w1560/getpro/habr/post_images/3b2/1d4/634/3b21d463486257337769122555c94580.png)  
_Вывод команды lsof, вызванной с опцией -p на MacBook Air_  
  

### ▍Опция -P

  
Опция `-P` подавляет, для сетевых файлов, преобразование номеров портов в имена портов. Её полезно использовать в тех случаях, когда разрешение имён портов работает неправильно.  
  
Эту опцию можно использовать с другой опцией — `-n`, которая подавляет преобразование сетевых номеров в имена хостов для сетевых файлов. Она, кроме того, полезна при неправильно работающем разрешении имён хостов.  
  
Подавление обоих вышеупомянутых преобразований _иногда_ может ускорить работу `lsof`.  
  

### ▍Опция -i

  
Опция `-i` позволяет вывести сведения о файлах, интернет-адреса которых соответствуют заданному адресу. Если при вызове команды не задавать адреса, эта опция позволяет вывести сведения обо всех интернет-сокетах и сетевых файлах.  
  
С помощью `lsof` можно, например, посмотреть на TCP-соединения, открытые клиентом Slack или Dropbox. Ради интереса попробуйте посмотреть, сколько соединений открывают вкладки Chrome, каждая из которых является отдельным процессом. Посмотрим на соединения, открытые Slack:  
  

```
lsof -i -a -u $USER | grep Slack
```

  
![](https://habrastorage.org/r/w1560/getpro/habr/post_images/b88/eb5/51a/b88eb551a63c9423142e626a66781d6f.png)  
_Вывод сведений о соединениях, которые открыл Slack_  
  
А вот что с помощью `lsof` можно узнать о TCP-сокетах, открытых клиентом Dropbox:  
  
![](https://habrastorage.org/r/w1560/getpro/habr/post_images/ef5/594/f44/ef5594f44ce6c546573dbd35246f2ec0.png)  
_Вывод сведений о соединениях, которые открыл Dropbox_  
  
`Lsof` позволяет просматривать и сведения об UDP-соединениях с помощью команды `lsof -iUDP`.  
  
![](https://habrastorage.org/r/w1560/getpro/habr/post_images/ef9/cf4/d57/ef9cf4d57514cd28ad3b219d91970b14.png)  
_Вывод сведений об UDP-соединениях_  
  
С помощью команды `lsof -i 6` можно вывести список открытых соединений IPv6.  
  
![](https://habrastorage.org/r/w1560/getpro/habr/post_images/e71/f0b/8cb/e71f0b8cb26e78e77bc0b4a409598512.png)  
_Вывод сведений об IPv6-соединениях_  
  

### ▍Опция -t

  
Опция `-t` подавляет вывод всей информации за исключением ID процессов. Я часто использую её, если хочу перенаправить список PID какой-нибудь другой команде, в основном — `kill-9`.  
  

```
cindy@ubuntu:~$ lsof -t /var/log/dummy_svc.log
1235
2171
2188
2189
16758
16761
16762
```

---

Чем чаще я использую команду `lsof`, тем больше других инструментов она заменяет и тем больше полезного позволяет мне узнать. Надеюсь, теперь у `lsof` есть шанс принести пользу и вам.