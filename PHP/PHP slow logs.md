
---

- https://www.getpagespeed.com/server-setup/how-to-log-and-fix-slow-php-requests

---

PHP slow logs помогают отслеживать медленные скрипты и выявлять проблемные участки кода, замедляющие работу веб-приложения. В зависимости от веб-сервера (Apache, Nginx) и используемой версии PHP, процесс настройки может немного отличаться. Вот как можно подключить PHP slow logs для разных версий PHP.

### 1. Настройка PHP-FPM Slow Logs (для PHP-FPM)

PHP-FPM (FastCGI Process Manager) предоставляет возможность включить slow logs, если используется PHP в режиме FPM, что является распространенным выбором для Nginx и Apache с mod_proxy_fcgi.

1. Откройте конфигурационный файл пула PHP-FPM, например:
   ```bash
   /etc/php/<version>/fpm/pool.d/www.conf
   ```
   * Замените `<version>` на вашу версию PHP, например `7.4` или `8.1`.

2. Найдите или добавьте следующие параметры:
```ini
   ; Включает запись медленных запросов
   slowlog = /var/log/php-fpm/www-slow.log
   
   ; Устанавливает порог времени для медленного запроса, например, 3 секунды
   request_slowlog_timeout = 3s
```

3. Убедитесь, что пути к файлам существуют, и что PHP-FPM имеет к ним доступ. Вы можете создать файл и установить права доступа:
   ```bash
   sudo touch /var/log/php-fpm/www-slow.log
   sudo chmod 664 /var/log/php-fpm/www-slow.log
   sudo chown www-data:www-data /var/log/php-fpm/www-slow.log
   ```

4. Перезапустите PHP-FPM для применения изменений:
   ```bash
   sudo systemctl restart php<version>-fpm
   ```

Теперь PHP будет логировать скрипты, которые выполняются дольше, чем указано в `request_slowlog_timeout`. Записи будут появляться в файле `/var/log/php-fpm/www-slow.log`.

### 2. Настройка slow logs для Apache с mod_php

Для Apache с mod_php прямой поддержки slow logs нет, однако можно использовать альтернативный подход:

1. Установите настройки логирования ошибок в конфигурационном файле PHP (`php.ini`):
```ini
   log_errors = On
   error_log = /var/log/php-slow.log
```

2. Логирование медленных запросов можно контролировать через функцию `max_execution_time`. Если максимальное время превышено, PHP зафиксирует это как ошибку в указанном файле `error_log`.

### 3. Использование Xdebug для мониторинга медленных запросов

Xdebug может помочь в создании профиля выполнения запросов и выявлении медленных участков кода:

1. Установите и активируйте Xdebug.
2. В конфигурации Xdebug добавьте:
```ini
   xdebug.profiler_enable_trigger = 1
   xdebug.profiler_output_dir = "/var/log/xdebug"
```

3. Профилирование будет запускаться при добавлении `XDEBUG_PROFILE=1` к URL (например, `http://example.com?XDEBUG_PROFILE=1`), создавая профили работы кода.

### Советы по работе с slow logs

- Регулярно анализируйте логи, чтобы избегать накопления слишком большого объема данных.
- Используйте инструменты для анализа slow logs, такие как `grep` и `awk`, или специализированные анализаторы профилей (например, KCachegrind).
- Настраивайте время `request_slowlog_timeout` в зависимости от производительности сервера и требований приложения.

Эти настройки помогут выявить и устранить узкие места в PHP-коде, повышая производительность вашего приложения.