
---

- https://sysadm.ru/server/linux/database/postgresql/export-import/

```
$ psql --version
psql (PostgreSQL) 14.10 (Ubuntu 14.10-0ubuntu0.22.04.1)

$ pg_dump --version
pg_dump (PostgreSQL) 14.10 (Ubuntu 14.10-0ubuntu0.22.04.1)
```
###### pg_dump - снять дамп БД

```
// Если удаленный хост
// Значение в  <>  меняем на актуальные. После запуска утилиты будет запрошен пароль пользователя для доступа к СУБД.
$ pg_dump --host=<ServerName> --port=<5432> --dbname=<DBName> --username=<postgres> --format=c --file=<FullDumpName>
```
###### pg_restore - поднять дамп БД

```
// Если удаленный хост
//  Значение в  <>  меняем на актуальные. После запуска утилиты будет запрошен пароль пользователя для доступа к СУБД
$ pg_restore --host=<ServerName> --port=<5432> --dbname=<DBName> --username=<postgres> --format=c <FullDumpName>
```

> Если нужно покопать дамп, --format=c не нужно указывать

---

- https://selectel.ru/blog/postgresql-backup-tools/

### Утилита pg_dump

В PostgreSQL есть встроенный инструмент для создания резервных копий — утилита _pg_dump_. Утилита имеет простой синтаксис:

```
# pg_dump <параметры> <имя базы> > <файл для сохранения копии> 
```

В простейшем случае достаточно указать имя базы данных, которую в дальнейшем нужно будет восстановить. Резервная копия создается следующей командой:

```
# pg_dump zabbix > /tmp/zabbix.dump
```

Если требуется авторизация под определенным пользователем, можно воспользоваться ключом _-U_:

```
# pg_dump -U zabbix -W zabbix > /tmp/zabbix.dump # pg dump u postgres
```

Ключ -U определяет пользователя, а -W обязывает ввести пароль.

Чтобы сэкономить место на диске, можно сразу же сжимать дамп:

```
# pg_dump -U zabbix -W zabbix | gzip > /tmp/zabbix.gz
```

Резервное копирование обычно выполняется по расписанию, например, ежедневно в 3 часа ночи. Нижеприведенный пример скрипта не только выполняет бэкап, но и удаляет все файлы старше 61 дня (за исключением 15-го числа месяца).

```
#!/bin/sh

PATH=/etc:/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin

PGPASSWORD=some_password
export PGPASSWORD
pathB=/mnt/backup
dbUser=dbadmin
database=zabbix


find $pathB \( -name "*-1[^5].*" -o -name "*-[023]?.*" \) -ctime +61 -delete
pg_dump -U $dbUser $database | gzip > $pathB/pgsql_$(date "+%Y-%m-%d").sql.gz


unset PGPASSWORD
```

Чтобы настроить регулярное выполнение, выполним следующую команду в планировщике _crontab_:

```
# crontab -e
3 0 * * * /etc/scripts/pgsql_dump.sh # postgres pg dump
```

Чтобы выполнить аналогичную команду на удаленном сервере, достаточно добавить ключ _-h_:

```
# pg_dump -h 192.168.56.101 zabbix > /tmp/zabbix.dump
```

Ключ _-t_ задает таблицу, для которой нужно создать резервную копию:

```
# pg_dump -t history zabbix > /tmp/zabbix.dump # postgres dump table
```

При помощи специальных ключей можно создавать резервные копии структуры данных или непосредственно данных:

```
# pg_dump --schema-only zabbix > /tmp/zabbix.dump
# pg_dump --data-only zabbix > /tmp/zabbix.dump
```

У утилиты pg_dump также есть ключи для сохранения дампа в другие форматы. Чтобы сохранить копию в виде бинарного файла используются ключи _-Fc_:

```
# pg_dump -Fc zabbix > /tmp/zabbix.bak
```

Чтобы создать архив — _-Ft_:

```
# pg_dump -Ft zabbix > /tmp/zabbix.tar
```

Чтобы сохранить в directory-формате — _-Fd_:

```
# pg_dump -Fd zabbix > /tmp/zabbix.dir
```

Резервное копирование в виде каталогов позволяет выполнять процесс в многопоточном режиме.

Ниже мы перечислим возможные параметры утилиты pg_dump.

**-d <имя_бд>, —dbname=имя_бд** — база данных, к которой выполняется подключение.

**-h <сервер>, —host=сервер** — имя сервера.

**-p <порт>, —port=порт** — порт для подключения.

**-U <пользователь>, —username=пользователь)** — учетная запись, используемое для подключения.

**-w, —no-password** — деактивация требования ввода пароля.

**-W, —password** — активация требования ввода пароля.

**—role=имя роли** — роль, от имени которой генерируется резервная копия.

**-a, —data-only** — вывод только данных, вместо схемы объектов (DDL).

**-b, —blobs** — параметр добавляет в выгрузку большие объекты.

**-c, —clean** — добавление команд DROP перед командами CREATE в файл резервной копии.

**-C, —create** — генерация реквизитов для подключения к базе данных в файле резервной копии.

**-E <кодировка>, —encoding=кодировка** — определение кодировки резервной копии.

**-f <файл>, —file=файл** — задает имя файла, в который будет сохраняться вывод утилиты.

**-F <формат>, —format=формат** — параметр определяет формат резервной копии. Доступные форматы:

- p, plain) — формирует текстовый SQL-скрипт;
- c, custom) — формирует резервную копию в архивном формате;
- d, directory) — формирует копию в directory-формате;
- t, tar) — формирует копию в формате tar.

**-j <число_заданий>, —jobs=число_заданий** — параметр активирует параллельную выгрузку для одновременной обработки нескольких таблиц (равной числу заданий). Работает только при выгрузке копии в формате directory.

**-n <схема>, —schema=схема** — выгрузка в файл копии только определенной схемы.

**-N <схема>, —exclude-schema=схема** — исключение из выгрузки определенных схем.

**-o, —oids** — добавляет в выгрузку идентификаторы объектов (OIDs) вместе с данными таблиц.

**-O, —no-owner** — деактивация создания команд, определяющих владельцев объектов в базе данных.

**-s, —schema-only** —добавление в выгрузку только схемы данных, без самих данных.

**-S <пользователь>, —superuser=пользователь** — учетная запись привилегированного пользователя, которая должна использоваться для отключения триггеров.

**-t <таблица>, —table=таблица** — активация выгрузки определенной таблицы.

**-T <таблица>, —exclude-table=таблица** —исключение из выгрузки определенной таблицы.

**-v, —verbose** — режим подробного логирования.

**-V, —version** — вывод версии pg_dump.

**-Z 0..9, —compress=0..9** — установка уровня сжатия данных. 0 — сжатие выключено.


---

### Утилита pg_restore

Утилита позволяет восстанавливать данные из резервных копий. Например, чтобы восстановить только определенную БД (в нашем примере zabbix), нужно запустить эту утилиту с параметром _-d_:

```
# pg_restore -d zabbix /tmp/zabbix.bak
```

Чтобы этой же утилитой восстановить определенную таблицу, нужно использовать ее с параметром _-t_:

```
# pg_restore -a -t history /tmp/zabbix.bak
```

Также утилитой pg_restore можно восстановить данные из бинарного или архивного файла. Соответственно:

```
# pg_restore -Fc zabbix.bak
# pg_restore -Ft zabbix.tar
```

При восстановлении можно одновременно создать новую базу:

```
# pg_restore -Ft -С zabbix.tar
```

Восстановить данные из дампа также возможно при помощи _psql_:

```
# psql zabbix < /tmp/zabbix.dump
```

Если для подключения нужно авторизоваться, вводим следующую команду:

```
# psql -U zabbix -W zabbix < /tmp/zabbix.dump
```

Ниже приведен синтаксис утилиты _pg_restore_.

**-h <сервер>, —host=сервер** — имя сервера, на котором работает база данных.

**-p <порт>, —port=порт** — TCP-порт, через база данных принимает подключения.

**-U <пользователь>, —username=пользователь** — имя пользователя для подключения..

**-w, —no-password** — деактивация требования ввода пароля.

**-W, —password** — активация требования ввода пароля.

**—role=имя роли** — роль, от имени которой выполняется восстановление резервная копия.

**<имя_файла>** — расположение восстанавливаемых данных.

**-a, —data-only** — восстановление данных без схемы.

**-c, —clean** — добавление операторов DROP перед операторами CREATE.

**-C, —create** — создание базы данных перед запуском процесса восстановления.

**-d <имя_бд>, —dbname=имя_бд** — имя целевой базы данных.

**-e, —exit-on-error** — завершение работы в случае возникновения ошибки при выполнении SQL-команд.

**-f <имя_файла>, —file=имя_файла** — файл для вывода сгенерированного скрипта.

**-F <формат>, —format=формат** — формат резервной копии. Допустимые форматы:

- p, plain — формирует текстовый SQL-скрипт;
- c, custom — формирует резервную копию в архивном формате;
- d, directory — формирует копию в directory-формате;
- t, tar — формирует копию в формате tar.

**-I <индекс>, —index=индекс** — восстановление только заданного индекса.

**-j <число-заданий>, —jobs=число-заданий** — запуск самых длительных операций в нескольких параллельных потоках.

**-l, —list)** — активация вывода содержимого архива.

**-L <файл-список>, —use-list=файл-список** — восстановление из архива элементов, перечисленных в файле-списке в соответствующем порядке.

**-n <пространство_имен>, —schema=схема** — восстановление объектов в указанной схеме.

**-O, —no-owner** — деактивация генерации команд, устанавливающих владение объектами по образцу исходной базы данных.

**-P <имя-функции(тип-аргумента[, …])>, —function=имя-функции(тип-аргумента[, …])** — восстановление только указанной функции.

**-s, —schema-only** — восстановление только схемы без самих данных.

**-S <пользователь>, —superuser=пользователь** — учетная запись привилегированного пользователя, используемая для отключения триггеров.

**-t <таблица>, —table=таблица** — восстановление определенной таблицы.

**-T <триггер>, —trigger=триггер** — восстановление конкретного триггера.

**-v, —verbose** — режим подробного логирования.

**-V, —version** — вывод версии утилиты pg_restore.